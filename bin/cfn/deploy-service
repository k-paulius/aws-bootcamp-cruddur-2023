#!/usr/bin/env bash
set -e

DIR_PATH=$(dirname $(readlink -f $0))
CFN_TEMPLATE_FILE="$DIR_PATH/../../aws/cfn/service/template.yaml"

cfn-lint $CFN_TEMPLATE_FILE

APP_ID="cruddur"
APP_ENV="prod"
CFN_STATE_BUCKET=$(aws ssm get-parameter --name "/$APP_ID/$APP_ENV/aws/cfn/state-bucket-name" --query 'Parameter.Value' --output text)
STACK_NAME=$(aws ssm get-parameter --name "/${APP_ID}/${APP_ENV}/aws/cfn/service-stack-name" --query 'Parameter.Value' --output text)

aws cloudformation deploy \
    --template-file $CFN_TEMPLATE_FILE \
    --stack-name $STACK_NAME \
    --s3-bucket $CFN_STATE_BUCKET \
    --capabilities CAPABILITY_NAMED_IAM \
    --parameter-overrides \
        pAppId=$APP_ID \
        pAppEnvironment=$APP_ENV \
        pParentECRStack=/$APP_ID/$APP_ENV/aws/cfn/ecr-stack-name \
        pParentClusterStack=/$APP_ID/$APP_ENV/aws/cfn/cluster-stack-name \
        pParentVPCStack=/$APP_ID/$APP_ENV/aws/cfn/networking-stack-name \
        pParentDBStack=/$APP_ID/$APP_ENV/aws/cfn/db-stack-name \
        pServiceName=backend \
        pBackEndApplicationPort=4567
